GCP Setup:
""""""""""
1) Open the GCP console and go to Menu -> Compute Engine -> VM instances.
2) Now click on "CREATE INSTANCE" and configure the VM settings (Make sure to select LINUX Ubuntu 20.4 image) and click create button.
3) This will create a new VM instance.
4) Next, in the search bar, search for "IP addresses" and click on the "IP addresses" option.
5) Now click on the "RESERVE EXTERNAL STATIC IP ADDRESS" option at the top.
6) Choose a name for the static address.
7) For "Attached to" option, select the VM instance you created above.
8) For rest of the fields, use the default values and click Reserve button.
9) This will attach a new static IP address to your newly created VM instance.

Server setup:
"""""""""""""
Apache Installation:
''''''''''''''''''''
1) Run the below command to update the local package index to reflect the latest upstream changes.
   "sudo apt update"
2) Then, install the apache2 package by executing the following command: "sudo apt install apache2"
3) This will install the apache2 and all of its dependencies.
4) At the end of the installation process, Ubuntu 20.04 starts Apache. The web server should already be up and running.
5) You can check its status by executing the following command: "sudo systemctl status apache2"
6) Finally, hit the URL in the following format "http://server-external-ip" on your browser, if everything is set correctly, you will see the apache default webpage.
7) To stop your web server, type: "sudo systemctl stop apache2"
8) To start the web server when it is stopped, type: "sudo systemctl start apache2"
9) To stop and then start the service again, type: "sudo systemctl restart apache2"

MySQL Installation:
'''''''''''''''''''
1) To install the mysql-server package, type: "sudo apt install mysql-server"
2) Ensure that the server is running using the systemctl start command: "sudo systemctl start mysql.service"
3) These commands will install and start MySQL.
4) Open up the MySQL prompt using the following command: "sudo mysql"
5) In the MySQL prompt, type the following ALTER command: "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';"
6) "password" should be your MySQL password.
7) After making this change, exit the MySQL prompt by typing the command: "exit"
8) Now run the command "sudo mysql_secure_installation"
9) This will take you through a series of prompts where you can make some changes to your MySQL installation’s security options.
8) The first prompt will ask whether you’d like to set up the Validate Password Plugin, which can be used to test the password strength of new MySQL users before deeming them valid.
9) If you elect to set up the Validate Password Plugin, any MySQL user you create that authenticates with a password will be required to have a password that satisfies the policy you select. 
10) The strongest policy level — which you can select by entering 2 — will require passwords to be at least eight characters long and include a mix of uppercase, lowercase, numeric, and special characters.
11) Regardless of whether you choose to set up the Validate Password Plugin, the next prompt will be to set a password for the MySQL root user. Enter and then confirm a secure password of your choice.
12) Assuming you’re satisfied with the strength of the password you just entered, enter Y to continue the script.
13) From there, you can press Y and then ENTER to accept the defaults for all the subsequent questions.
14) This will remove some anonymous users and the test database, disable remote root logins, and load these new rules so that MySQL immediately respects the changes you have made.
15) Once the script completes, your MySQL installation will be secured.
16) To check the status of the MySQL run the following command: "systemctl status mysql.service"

phpMyAdmin Installation:
''''''''''''''''''''''''
1) Install the PHP and few of its dependencies by executing the following command: "sudo apt install php libapache2-mod-php php-mysql"
2) Once the installation is finished, you can run the following command to confirm your PHP version: "php -v"
3) Now install the phpMyAdmin and its dependencies by executing the following command: "sudo apt install phpmyadmin php-mbstring php-zip php-gd php-json php-curl"
4) For the server selection, choose apache2. Note that, When the prompt appears, “apache2” is highlighted, but not selected. If you do not hit SPACE to select Apache, the installer will not move the necessary files during installation. Hit SPACE, TAB, and then ENTER to select Apache.
5) Select Yes when asked whether to use dbconfig-common to set up the database
6) You will then be asked to choose and confirm a MySQL application password for phpMyAdmin.
7) Assuming you installed MySQL by following steps in "MySQL Installation", you may have decided to enable the Validate Password plugin. 
8) As of this writing, enabling this component will trigger an error when you attempt to set a password for the phpmyadmin user
9) To resolve this, select the abort option to stop the installation process. Then, open up your MySQL prompt by typing: "sudo mysql"
10) From the prompt, run the following command to disable the Validate Password component: "UNINSTALL COMPONENT "file://component_validate_password";"
11) Following that, you can close the MySQL client: "exit"
12) Then try installing the phpmyadmin package again and it will work as expected: "sudo apt install phpmyadmin"
13) Then again open the MySQL prompt by running "sudo mysql" and then run the following command to re-enable the Validate Password component: "INSTALL COMPONENT "file://component_validate_password";"
14) Then close the MySQL prompt by running "exit" command.
15) Then execute the following command: "sudo phpenmod mbstring"
16) Then restart the apache server for your changes to be recognized: "sudo systemctl restart apache2"
17) You can now access the web interface by visiting your server’s domain name or public IP address followed by /phpmyadmin: "http://your_domain_or_IP/phpmyadmin"

Node Version Manager (NVM) Installation:
'''''''''''''''''''''''''''''''''''''''''
1) Run the following command in the terminal to install the NVM package: "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash"
2) Make sure to source your .bashrc file by running: "source ~/.bashrc"
3) You can install a Node v18.15.0 by running the following command: "nvm install v18.15.0"
4) Once installed you can check the installation by running the "node -v" & "npm -v" commands.

Creating Virtual Host Configuration:
''''''''''''''''''''''''''''''''''''
1) Navigate into /etc/apache2/sites-available by running "cd /etc/apache2/sites-available"
2) Run the following command in the terminal to create a configuration file for the application, "sudo vim team.conf"
3) Add the below lines to the "team.conf" file.

<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www 
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

4) With this VirtualHost configuration, we’re telling Apache to serve your domain using /var/www/ as the web root directory
5) You can now use a2ensite to enable the new virtual host: "sudo a2ensite team"
6) You might want to disable the default website that comes installed with Apache. This is required if you’re not using a custom domain name, because in this case Apache’s default configuration would overwrite your virtual host. 
7) To disable Apache’s default website, type: "sudo a2dissite 000-default"
8) To make sure your configuration file doesn’t contain syntax errors, run: "sudo apache2ctl configtest"
9) Finally, reload Apache so these changes take effect: "sudo systemctl reload apache2"

Creating GCP Firewall Rule for NodeJs Backend:
''''''''''''''''''''''''''''''''''''''''''''''
1) In the GCP console, search "Firewall" and choose "Firewall" option.
2) Now click the "CREATE FIREWALL RULE" option. Enter a name for firewall rule.
3) Set Targets as Specified target tags
4) In Target tags field, enter "http-5050".
5) In Source IPv4 ranges field, enter 0.0.0.0/0
6) For Protocals & ports, select "Specified protocols and ports" and then check "TCP". In the ports field, enter 5050 and 22.
7) Finally, click the "CREATE" button.
8) Now go to the VM instanes list and click the VM instance name.
9) And click on the Edit option at the top.
10) Under Network tags, add "http-5050" and click the Save button.
11) The above steps will make the port 5050 publicly available. In the port 5050, we will be running our backend application.

Database Import:
""""""""""""""""

1) Import the dml.sql file on the phpmyadmin from digibot repository.
2) Make sure the roles are imported correctly.
3) Make sure "Root" document is added the to the table with the ID 4 or run the below insert command:

INSERT INTO `documents` (`id`, `parentId`, `teamId`, `name`, `tooltip`, `isDefault`, `isFile`, `created`) VALUES
(4, NULL, NULL, 'Root', 'tooltip', 1, 0, '2023-08-22 13:51:49');

Backend Application Setup:
""""""""""""""""""""""""""
1) Clone the "digibot" repo.
2) Move the backend folder into the root directory of the VM instance and change its name to team-ai-backend.
3) Now give permission to application to create folders by running "sudo chown -R user:user /team-ai-backend" command.
4) Navigate into the team-ai-backend folder and install the dependencies by running "npm install" command
5) Once installed make sure to provide the correct directory path for tempImage, tempCsv, documents & tempText folders on .env file.
6) Make sure to update the .env file with the correct credentials for BigQuery & MySQL Database.
7) Make sure to clean up the test data under "documents" folders & "upload/userAvatars & upload/companyLogos" folders. (If necessary and don't delete the "default_avatar.png" files)
8) In the GCP terminal, navigate into "team-ai-backend" folder and install the PM2 library globally (Production process manager for Nodejs) by running "npm install pm2 -g".
9) To start the backend server, run the following command: "pm2 start server.js"
10) This will run the beckend server on the 5050 port.
11) To check if its working, hit the following URL in your browser, "http://your-external-ip:5050/user-avatars/default_avatar.png".
12) If you have setup the server correctly, default_avatar.png file will be displayed on your browser.
13) In the .env file, make sure to provide the base URL for the frontend app (FRONTEND_BASE_URL).
14) It should be in the following format: "http://external-ip". (Note: Do not add / at the end of URL)
15) You can restart the server by running "pm2 restart server.js" to reflect the changes.

Frontend Application Setup:
"""""""""""""""""""""""""""
1) Navigate into the digibot/code/frontend folder in the repo clone stored on your local machine.
2) In the .env file, change the backend base URL. (Ex: http://your-external-ip:5050)
3) In the package.json, for the "homePage" property, makes sure it is set as '/'.
4) Now execute the following command on your local machine's terminal: "npm run build"
5) This will create a production build for the frontend application.
6) Once build is created, a build directory will be created on the root of your project directory.
7) Move the following files and folders within the build directory to the VM instance, "asset-manifest.json, index.html, manifest.json, media, splash-screen.css, static, .htaccess".
8) Above files and folders should be moved under /var/www/ folder in the VM instance.
9) Then navigate into the '/etc/apache2' folder by running "cd /etc/apache2" command.
10) Open the apache2.conf file using "sudo vim apache2.conf"
11) Now change the following lines,

<Directory /var/www/>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
</Directory>

to

<Directory /var/www/>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
</Directory>

12) Save the file by pressing, Esc and then :wq and then enter keys.
13) If everything is set correctly, you will be able to view the application by hitting the App URL in your browser.
14) Make sure to add the frontend base URL on the backend .env file.

Server restart:
'''''''''''''''
Whenever VM is stopped, after resuming it you need to start the Apache and MySQL server again,

To start the apache server, run the below code:

sudo systemctl start apache2

To start the MySQL server, run the below code:

sudo systemctl start mysql.service

You must also need to start the backend server again, run the below commands to start the backend server:

cd /team-ai-backend
pm2 start server.js

Frontend Build Update:
''''''''''''''''''''''
On Updating the frontend build if Internal Server error or misconfiguration error occurs it means 
"mod_rewrite" module is not enabled in Apache :-

1) To enable mod_rewrite module run "sudo a2enmod rewrite" command.
2) Now restart your apache server with this "sudo systemctl restart apache2" command.
3) Now you can check your frontend will work on http://your-external-ip 

When this message occurs on opening SSH window :- (We are unable to connect to the VM on port 22)
''''''''''''''''''''''''''''''''''''''''''''''''
1) In the GCP console, search "Firewall" and choose "Firewall" option.
2) Check that our created Firewall Rule has the most priority of 1000.
3) Else decrease the priority of other Firewall Rules.
4) Restart the VM instance.

Redis Setup:
''''''''''''

To install Redis on Windows follow the steps provided in the below link:

https://redis.io/docs/install/install-redis/install-redis-on-linux/

Make sure to run the following command to start the redis server: "sudo service redis-server start" 

Note: Start the redis server before starting the backend.


Stripe Webhook Integration:
'''''''''''''''''''''''''''
Create a stripe account and create a new project on the top left select menu and select it.

Make sure the test mode is enabled on the top right.

Now create a products on pricing table, to do that click "More +" option on dashboard side bar, then click "Product Catalog".

Now add new products, in our case we need to create 3 products:

1) Solo -> $9 -> Recurring
2) Team -> $79 -> Recurring

Once created, go to the phpmyadmin and open the "subscription-packages" table.

Then, update the priceId for solo (priceId of Solo), and team (priceId of Team).

You will be able to find the price Id on the product detail page of the products you created on the stripe.

It should look like the following format: "price_1OSyr9EdBoWbUwLVM5FjkGJM"

Now click the developer menu on the top right and then go to API keys section.

Now create a standard keys, this will create a "Publishable key" & "Secret key".

Copy only the secret key and paste it on the backend .env file under "STRIPE_SECRET_KEY" variable.

Now go to "Webhooks" section and click Add endpoint button.

For the Endpoint URL paste the backend URL "http://ip-address:5050/stripe/webhook".

Then for "Listen to" -> set it as "Events on your account".

For "Select events to listen to" -> select "Select events" ->
Checkout -> checkout.session.completed,
Customer -> customer.subscription.deleted,
Invoice -> invoice.payment_failed,
Invoice -> invoice.payment_succeeded

Finally click "Add events", this will create a new Webhook listener.

Once the listener is created, copy the "Signing secret" by clicking "Reveal" and then copy.

Now paste the "Signing secret" on the .env file under "STRIPE_ENDPOINT_SECRET" variable.

Thats it. Now all the webhook events will be monitored and notified to the specified URL (in our case "http://ip-address:5050/stripe/webhook")

SSO SETUP:
''''''''''
Google:
'''''''
Step-1:
Go to GCP Dashboard => APIs & Services => OAuth Concent Screen => { Select external -> Enter App Name -> Select Support Email -> Enter Developer email -> Save & Continue -> Save} 
Step-2:
Go to GCP Dashboard => APIs & Services => Credentials => Create Credentials => OAuth Client ID => { Application Type (Web Application) -> Enter Name (DigiBot) -> Authorized JavaScript origins > Add(FRONTEND_BASE_URL) -> Authorized redirect URIs > Add(BACKEND_BASE_URL/auth/providers/google/callback) -> Cilck Save}
Step-3: Note Down the client id and client secret. Update the following in env file GOOGLE_OAUTH_REDIRECT_URL, GOOGLEDRIVE_OAUTH_REDIRECT_URL, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET

Microsoft:
''''''''''
1. Go to the https://portal.azure.com/
2. Navigate to Azure Active Directory and select "App registrations" and register a new application.
3. Enter the name (DigiBot), select option (Any Azure AD directory - Multitenant and personal Microsoft accounts), enter redirect URI (BACKEND_BASE_URL/auth/providers/onedrive/callback) and Click register.
4. Note down the Application (client) ID, Directory (tenant) ID.
5. After registering application, navigate to the "Certificates & secrets" tab.
6. Under the "Client secrets" section, click on "New client secret".
7. Enter a description for secret and choose an expiration duration.
8. Click on "Add" to generate the client secret.
9. Once generated, note down the value of the client secret.
10. Update the following in env file MICROSOFT_OAUTH_REDIRECT_URL, MICROSOFT_DRIVE_REDIRECT_URL, MICROSOFT_CLIENT_ID, MICROSOFT_CLIENT_SECRET, MICROSOFT_TENANT_ID.

Google Cloud Storage Setup:
'''''''''''''''''''''''''''
1. Go to the Google Cloud Console: https://console.cloud.google.com/, select the project.
2. In the Google Cloud Console, navigate to the "APIs & Services" > "Library" page.
3. Search for "Cloud Storage API" and select it from the results and Click the "Enable" button.
4. In the Google Cloud Console, navigate to the "IAM & Admin" > "Service accounts" page.
5. Click the "Create Service Account" button.
6. Enter a name and description for service account, then click "Create".
7. Assign the necessary roles to service account. Assign "Cloud Storage Admin" role to access the Cloud Storage API. Assign "storage.buckets.list, storage.buckets.get, storage.buckets.create, storage.buckets.update, and storage.buckets.delete" role to access the Google Cloud Storage API.
8. Click "Continue" and then "Done".
9. Find the service account you created on the "Service accounts" page in the Google Cloud Console.
10. Click on the service account's email address.
11. Navigate to the "Keys" tab.
12. Click the "Add Key" drop-down menu and select "Create new key".
14. Choose the JSON key type and click "Create".
15. Save the downloaded JSON file securely. Use the JSON key file to authenticate application.
16. Go to the Google Cloud Storage.
17. Click on the "Create bucket" button.
18. Enter a name for bucket.
19. Choose a default storage class.
20. Choose a location where you want your data to be stored.
21. Click "Create".
22. Update the following in env file GOOGLE_CREDENTIALS (path of JSON file), GOOGLE_STORAGE_BUCKET_NAME.
23. Open cloud shell.
24. Create cors-config.json and update the origin (FRONTEND_BASE_URL) in it
[
    {
      "origin": ["FRONTEND_BASE_URL"], 
      "method": ["GET", "HEAD", "POST", "PUT", "DELETE", "OPTIONS"],
      "responseHeader": ["Content-Type", "Authorization"],
      "maxAgeSeconds": 3600
    }
]
25. Use the command to update the cors policy of the bucket "gcloud storage buckets update gs://%bucket-name% --cors-file=%uploaded-cors-file-name%"

Google Cloud SQL setup:
'''''''''''''''''''''''
1. Go to the Google Cloud Console: https://console.cloud.google.com/, select the project.
2. In the Google Cloud Console, navigate to the "APIs & Services" > "Library" page.
3. Search for "Cloud SQL Admin API" and select it from the results.
4. Click the "Enable" button.
5. Create a Cloud SQL Instance.
6. Configure your instance.
7. Update the DATABASE_HOST with the public IP address of the Cloud SQL Instance.
8. Update the DATABASE_NAME, DATABASE_USER_NAME, DATABASE_PASSWORD in the env file.
9. Go to Cloud SQL->Connections->Networking and add your IP address in the Authorized networks.

Dropbox setup:
''''''''''''''
1. Go to the Dropbox App Console and sign in to your Dropbox account.
2. Click on Create App.
3. Choose the type of access you want: Full Dropbox.
4. Name your app and click Create App.
5. Dropbox will provide you with an App key and an Access token copy them and update in backend .env file DROPBOX_APP_KEY and DROPBOX_ACCESS_TOKEN, which you'll use in your code for authentication.
6. Add the redirect URI where Dropbox will redirect users after they authenticate with your app. Ensure the URI matches the one used in your OAuth flow (FRONTEND_BASE_URL).
7. In Chooser / Saver / Embedder domains, provide "domain" for live use.
8. Dropbox scope:
files.content.read: Read file content.

Onedrive setup:
'''''''''''''''
1. Open the registered application in the Azure portal.
2. Select Authentication -> Add a platform -> Single page application -> Enter the redirect URL (FRONTEND_BASE_URL/upload-document) and click configure.
3. For Implicit grant and hybrid flows: Select 
Access tokens (used for implicit flows)
ID tokens (used for implicit and hybrid flows)
4. Select API permissions -> Add permission -> Microsoft APIs -> Microsoft Graph -> Delegated permissions -> Select Files.Read.
5. Click on Grant admin concent for default Directory.

Wordpress setup:
''''''''''''''''
1. Visit https://developer.wordpress.com/apps/ and sign in with your WordPress.com account.
2. Click "Create New Application"
3. Fill out your application details
4. Set the Redirect URL (BACKEND_BASE_URL/wordpress/callback)
5. Set the Javascript Origins (FRONTEND_BASE_URL)
6. Click "Create"
7. WordPress will generate your Client ID and Client Secret — copy both and store them in your .env file as:
WORDPRESS_CLIENT_ID and WORDPRESS_CLIENT_SECRET

Slack setup:
''''''''''''
1. Visit https://api.slack.com/apps and sign in with your Slack account.
2. Click on “Create New App”
3. Fill details and click Create App.
4. Configure OAuth & Permissions
5. Under Redirect URLs, add your backend redirect URI (BACKEND_BASE_URL/slack/callback)
6. Under Scopes, add required scopes depending on your use case. For file access
files:read, users:read, channels:read
7. Go to Basic Information and copy Client ID, Client Secret and Verification Token and store them in your .env file as: SLACK_CLIENT_ID, SLACK_CLIENT_SECRET and SLACK_VERIFICATION_TOKEN
